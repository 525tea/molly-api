name: Build, Push to ECR, and Deploy to EC2

on:
  push:
    branches:
      - deploy  # deploy ë¸Œëžœì¹˜ í‘¸ì‹œ ì‹œ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Create application-secret.yml íŒŒì¼ ìƒì„±
        run: |
          echo "${{ secrets.APPLICATION_SECRET }}" > application-secret.yml
          
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Log in to Amazon ECR (for GitHub Actions)
        run: |
          aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-2.amazonaws.com

      - name: Build Docker Image
        run: |
          docker build \
          --build-arg APPLICATION_SECRET=application-secret.yml \
          -t molly-backend .

      - name: Tag Docker Image
        run: |
          docker tag molly-backend:latest ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-2.amazonaws.com/molly-backend:latest

      - name: Push Docker Image to ECR
        run: |
          docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-2.amazonaws.com/molly-backend:latest

      - name: Set up SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy and Run Docker Container on EC2
        run: |
          ssh -i ~/.ssh/id_rsa ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
          echo "ðŸš€ Deploying latest Docker container from ECR..."

          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
          echo "ðŸ›‘ Stopping existing container..."
          docker stop molly-backend || true
          docker rm molly-backend || true

          # ëª¨ë“  ì¤‘ì§€ëœ ì»¨í…Œì´ë„ˆ ì‚­ì œ (Dangling í¬í•¨)
          echo "ðŸ—‘ Removing all stopped containers..."
          docker rm $(docker ps -aq) || true

          # ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” Docker ì´ë¯¸ì§€ ì‚­ì œ
          echo "ðŸ—‘ Removing unused Docker images..."
          docker image prune -af || true

          # AWS ECR ë¡œê·¸ì¸ (for EC2)
          echo "ðŸ”‘ Logging in to AWS ECR..."
          aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-2.amazonaws.com

          # ìµœì‹  Docker ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
          echo "ðŸ“¥ Pulling latest Docker image..."
          docker pull ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-2.amazonaws.com/molly-backend:latest

          # ì»¨í…Œì´ë„ˆ ì‹¤í–‰
          echo "ðŸš€ Running new container..."
          docker run -d --name molly-backend -p 8080:8080 ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-2.amazonaws.com/molly-backend:latest

          echo "âœ… Deployment complete!"
          EOF
